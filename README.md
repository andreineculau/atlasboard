Getting Started - A Dashboard in 5 Steps
============
1. Install node
2. Install atlasboard

    2.1 Ideally, this will one day be published as an official npm package, but at the moment you'll need to download the source directly, then tell node that the module can be found there.

        # Clone the repo
        $ git clone git@bitbucket.org:atlassian/atlasboard.git

        # Tell node that the atlasboard module is located here
        $ cd atlasboard
        $ npm link
        $ cd path/to/my-wallboard
        $ npm link atlasboard
        $ npm install # This will install atlasboard's dependencies too

3. Create a new dashboard with `atlasboard new mydashboard`
4. Start your server with `atlasboard start`
5. Check it out at http://localhost:4444/

Everything Else
=============
Creating your own Dashboard Project, Job, Widget or Dashboard
-----------
AtlasBoard has a built-in project/job/widget generator, so this is all very straightforward and simple.

**To create a wallboard project:**

`$ atlasboard new PROJECTNAME` Creates a folder in this directory called PROJECTNAME which contains all the necessities for a fully functional AtlasBoard server

**To create a new job/widget/dashboard:**

`$ atlasboard generate job JOBNAME` (Replace job with widget or dashboard depending on what you want.) Creates an item with that name in the relevant place. Dashboard is then accessible at localhost:4444/NAME

**To run your AtlasBoard server:**

`$ atlasboard start`

FAQs
-------
**What Programming Languages do I need to know?**

JavaScript. That's it. If you want things to look nicer, some very basic level HTML and CSS might come in handy too.

**Which port is the AtlasBoard server hosted on?**

By default, this is port 4444 (i.e. the server will be at http://localhost:4444). Currently, this can be changed in the atlasboard/lib/atlasboard.js file (this will involve editing the node module's source code, so bear that in mind if you update AtlasBoard).

**Does dragging the widgets around on my screen affect other people's dashboards?**

No, this is just a local thing. Unfortunately, these changes you make don't persist (yet) either.

**Where can I learn about making widgets/jobs/dashboards?**

I recommend making a sample project by using atlasboard new PROJECTNAME. This will generate the dashboard shown here, and contains some great sample code for a range of different widget/job types.

**What format should my dashboard be in?**

If you're writing a new dashboard file (i.e. a file that lets you view a different set of widgets while still connecting to the same server), you can write this as a JSON file (easiest, preferred, see existing examples) or an EJS file.

Code Examples
=============

Dashboards
-----------

Dashboards should be written as a JSON object with three elements:

1. `title` the title, if any, that you'd like at the top of your page

2. `customJs` the names of any extra JavaScript libraries, located in assets/javascripts, that you'd like included

3. `widgets` an array of objects detailing each widget to be displayed on the dashboard. Each `widgets` object has the following markup:

    3.1 `row` 1 - 4

    3.2 `col` 1 - 6

    3.3 `width` 1 - 6

    3.4 `height` 1 - 4

    3.5 `widget` The name of the folder in widgets/ that contains your widget's HTML, JS and CSS files

    3.6 `events` An array of event names that will pass data to the widget. An event name is generated by %jobName%-%JSONConfigFileName%

        {
            "title": false,
            "customJS" : [],
            "widgets" : [
                {"row" : 1, "col" : 1, "width" : 2, "height" : 3, "widget" : "quotes", "events" : ["quotes-famous"]}
            ]
        }

Jobs
-----------

Jobs come in two parts: the JavaScript file and the JSON configuration file. The JSON file is an object whose contents are accessible through the `config` variable in the job.

This is a basic "Hello World" job:

    module.exports = function(widgets, scheduler, config) {
        var refreshTime = 10 * 60 * 1000; //The job will run once every refreshTime milliseconds

        scheduler.schedule(function() {
            var text = "Hello World!";

            //We're sending the data as an object to any widget listening to this "job" here
            widgets.sendData({title: config.widgetTitle, text: text});

        }, refreshTime);
    }

**Database Query Jobs**

For database jobs, the pg node module is recommended

    var pg = require('pg');

This sample code accesses a database and operates on the returned rows

    // Use config parameters for database connections, including username/password combinations from globalAuth.json
    var database = config.database;
    var conString = "tcp://" + config.globalAuth.salesdb.username + ":" + config.globalAuth.salesdb.password + "@" + database.host + ":" + database.port + "/" + database.database;

    var salesQueryString = 	"SELECT * FROM issues limit 100"

    pg.connect(conString, function(err, client) {
        var issues = [];
        /*
        * Our database details (retrieved from the database defined in the JSON config file) won't work here,
        * so the err if statement will trigger. Normally, we'd go through to the client.query() section when
        * the connection works.
        */
        if (err) {
            console.log("ERROR connecting to %s:%d at %s", database.database, database.port, database.host);
            return;
        }
        client.query(salesQueryString, function(err, result) {
            //Example operation on query results
            result.rows.forEach(function(row) {
            issues.push({"issueType" : row.type, "frequency" : row.count});
            });

            widgets.sendData({issues: issues, title: config.widgetTitle});
        });
    });


**HTTP Query Jobs**
For HTTP request jobs, the request and cheerio node modules are recommended

    var request = require('request'),
        $ = require('cheerio');

This sample code grabs a HTTP page and operates on its contents using cheerio

    //Sample connection options, including authorization headers (if they're required)
    var options = {
        url: config.url,
        headers: {
            "authorization": "Basic " + new Buffer(config.globalAuth.natgeo.username + ":" + config.globalAuth.natgeo.password).toString("base64")
        }
    };

    request(options, function(error, response, body) {
        // body contains our web page HTML

        if (!response || response.statusCode != 200) {
            console.log("ERROR: Couldn't access the web page at %s", options.url)
            return;
        } else {
            var result = $('.primary_photo img', body).attr('src');
        }

        widgets.sendData({imageSrc: result, title: config.widgetTitle});
    });

**iCal Parsing**
To parse a calendar with a .ics file extension, use the ical node module. In this example, we'll use underscore as well.

    var ical = require('ical'),
        _ = require('underscore');

This sample code downloads an .ics calendar from a given URL and gets the newest events from it

    var formatDate = function(date) {
        var d = date.getDate();
        var m = date.getMonth()+1;
        return '' + (m<=9?'0'+m:m) + '/' + (d<=9?'0'+d:d);
    };

    ical.fromURL(config.calendarUrl, {}, function(err, data) {

        var events = _.sortBy(data, function(event) { return event.start; });
        events = _.filter(events, function(event) { return event.end >= new Date(); });

        var result = [];
        var counter = 0;
        events.forEach(function(event) {
            if (counter < config.maxEntries) {
                counter++;
                result.push({startDate: formatDate(event.start), endDate: formatDate(event.end), summary: event.summary});
            }
        });

        widgets.sendData({events: result, title: config.widgetTitle});
    })


Widgets
-----------

Each widget is comprised of a HTML file (the HTML that fills the widget's <li> element on the dashboard), a CSS file and, most importantly, a JavaScript file. Each of these files must have the same name as the folder they're located in.

This is a basic widget to print plaintext provided by the "Hello World" job above (where `widgetName` is the name of the widget):

    Widgets.widgetName = {
        //runs when we receive data from the job
        onData: function(el, data) {

            //The parameters our job passed through are in the data object
            //el is our widget element, so our actions should all be relative to that
            if (data.title) {
                $('h2', el).text(data.title);
            }

            $('.content', el).html(data.text);
        }
    };


Legal
==============

License: Apache License 2.0
Copyright 2013 Atlassian

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.