var assert = require ('assert');
var path = require ('path');
var item_manager = require('../lib/item-manager');

describe ('item_manager', function(){

  var packagesLocalFolder = path.join(process.cwd(), "/test/packages");
  var packagesAtlasboardFolder = path.join(process.cwd(), "/packages");

  describe ('dashboards', function(){

    it('should have the right number of dashboards', function(done){
      item_manager.get([packagesLocalFolder, packagesAtlasboardFolder], "dashboards", ".json", function(err, dashboards){
        assert.ok(!err, err);
        assert.equal(5, dashboards.length);
        done();
      });
    });

    it('should not read dashboards with invalid extensions', function(done){
      item_manager.get([packagesLocalFolder, packagesAtlasboardFolder], "dashboards", ".json", function(err, dashboards){
        assert.ok(!err, err);
        dashboards.forEach(function(item){
          assert.ok(path.extname(item) === ".json");
        });
        done();
      });
    });
  });

  describe ('jobs', function(){
    it('should have the right number of jobs', function(done){
      item_manager.get([packagesLocalFolder], "jobs", ".js", function(err, jobs){
        assert.ok(!err, err);
        assert.equal(6, jobs.length);
        done();
      });
    });

    it('should be able to pick up the right job with namespacing (1)', function(done){
      item_manager.get_first([packagesLocalFolder], "otherpackage1#job1", "jobs", ".js", function(err, job_path){
        assert.ok(!err, err);
        assert.ok(job_path);
        var job = require (job_path);
        var result = job();
        assert.equal ("otherpackage1#job1", result);
        done();
      });
    });

    it('should be able to pick up the right job with namespacing (2)', function(done){
      item_manager.get_first([packagesLocalFolder], "default#job1", "jobs", ".js", function(err, job_path){
        assert.ok(!err, err);
        assert.ok(job_path);
        var job = require (job_path);
        var result = job();
        assert.equal ("default#job1", result);
        done();
      });
    });

  });

  describe ('widgets', function(){
    it('should have the right number of widgets', function(done){
      item_manager.get([packagesLocalFolder], "widgets", ".js", function(err, widgets){
        assert.ok(!err, err);
        assert.equal(1, widgets.length);
        done();
      });
    });
  });

});