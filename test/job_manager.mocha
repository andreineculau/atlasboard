var assert = require ('assert');
var path = require ('path');
var jobs_manager = require('../lib/atlasboard_job_manager');

describe ('job_manager', function(){

  var packagesPath = path.join(process.cwd(), "/test/packages");
  var configPath = path.join(process.cwd(), "/test/config");

  it('should have right dashboard names', function(done){

    jobs_manager.get_jobs(packagesPath, configPath, function(err, job_workers){
      assert.ok(!err, err);
      assert.equal(job_workers.length, 9);

      assert.equal(job_workers[0].dashboard_name, "test_dashboard1");
      assert.equal(job_workers[1].dashboard_name, "test_dashboard1");

      assert.equal(job_workers[2].dashboard_name, "test_dashboard2");
      assert.equal(job_workers[3].dashboard_name, "test_dashboard2");
      assert.equal(job_workers[4].dashboard_name, "test_dashboard2");

      assert.equal(job_workers[5].dashboard_name, "other_test_dashboard1");
      done();
    });
  });


  it('should be able to get disable widgets', function(done){
    jobs_manager.get_jobs(packagesPath, configPath, function(err, job_workers){
      assert.ok(!err);
      var disabled_jobs = job_workers.filter(function(job){ return job.widget_item.enabled;});
      assert.equal(7, disabled_jobs.length);
      done();
    });
  });

  it('should have tasks', function(done){
    jobs_manager.get_jobs(packagesPath, configPath, function(err, job_workers){
      assert.ok(!err);
      job_workers.forEach(function(job){
        if (job.job_name !== "--invalidjob--"){
          assert.ok(typeof job.task === "function" );
        }
      });
      done();
    });
  });


  it('should have config', function(done){
    jobs_manager.get_jobs(packagesPath, configPath, function(err, job_workers){
      assert.ok(!err);
      // job_conf1 is defined in general config file (shared config)
      // the rest of them are defined in the related dashboard file.
      job_workers.forEach(function(job){
          assert.ok(job.config.interval);
      });
      done();
    });
  });

});